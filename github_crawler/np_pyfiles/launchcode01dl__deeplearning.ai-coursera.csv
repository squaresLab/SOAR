file_path,api_count,code
course 4 - Convolutional Neural Networks/programming assignments/inception_blocks_v2.py,0,"b'import tensorflow as tf\nimport numpy as np\nimport os\nfrom numpy import genfromtxt\nfrom keras import backend as K\nfrom keras.layers import Conv2D, ZeroPadding2D, Activation, Input, concatenate\nfrom keras.models import Model\nfrom keras.layers.normalization import BatchNormalization\nfrom keras.layers.pooling import MaxPooling2D, AveragePooling2D\nimport fr_utils\nfrom keras.layers.core import Lambda, Flatten, Dense\n\ndef inception_block_1a(X):\n    """"""\n    Implementation of an inception block\n    """"""\n    \n    X_3x3 = Conv2D(96, (1, 1), data_format=\'channels_first\', name =\'inception_3a_3x3_conv1\')(X)\n    X_3x3 = BatchNormalization(axis=1, epsilon=0.00001, name = \'inception_3a_3x3_bn1\')(X_3x3)\n    X_3x3 = Activation(\'relu\')(X_3x3)\n    X_3x3 = ZeroPadding2D(padding=(1, 1), data_format=\'channels_first\')(X_3x3)\n    X_3x3 = Conv2D(128, (3, 3), data_format=\'channels_first\', name=\'inception_3a_3x3_conv2\')(X_3x3)\n    X_3x3 = BatchNormalization(axis=1, epsilon=0.00001, name=\'inception_3a_3x3_bn2\')(X_3x3)\n    X_3x3 = Activation(\'relu\')(X_3x3)\n    \n    X_5x5 = Conv2D(16, (1, 1), data_format=\'channels_first\', name=\'inception_3a_5x5_conv1\')(X)\n    X_5x5 = BatchNormalization(axis=1, epsilon=0.00001, name=\'inception_3a_5x5_bn1\')(X_5x5)\n    X_5x5 = Activation(\'relu\')(X_5x5)\n    X_5x5 = ZeroPadding2D(padding=(2, 2), data_format=\'channels_first\')(X_5x5)\n    X_5x5 = Conv2D(32, (5, 5), data_format=\'channels_first\', name=\'inception_3a_5x5_conv2\')(X_5x5)\n    X_5x5 = BatchNormalization(axis=1, epsilon=0.00001, name=\'inception_3a_5x5_bn2\')(X_5x5)\n    X_5x5 = Activation(\'relu\')(X_5x5)\n\n    X_pool = MaxPooling2D(pool_size=3, strides=2, data_format=\'channels_first\')(X)\n    X_pool = Conv2D(32, (1, 1), data_format=\'channels_first\', name=\'inception_3a_pool_conv\')(X_pool)\n    X_pool = BatchNormalization(axis=1, epsilon=0.00001, name=\'inception_3a_pool_bn\')(X_pool)\n    X_pool = Activation(\'relu\')(X_pool)\n    X_pool = ZeroPadding2D(padding=((3, 4), (3, 4)), data_format=\'channels_first\')(X_pool)\n\n    X_1x1 = Conv2D(64, (1, 1), data_format=\'channels_first\', name=\'inception_3a_1x1_conv\')(X)\n    X_1x1 = BatchNormalization(axis=1, epsilon=0.00001, name=\'inception_3a_1x1_bn\')(X_1x1)\n    X_1x1 = Activation(\'relu\')(X_1x1)\n        \n    # CONCAT\n    inception = concatenate([X_3x3, X_5x5, X_pool, X_1x1], axis=1)\n\n    return inception\n\ndef inception_block_1b(X):\n    X_3x3 = Conv2D(96, (1, 1), data_format=\'channels_first\', name=\'inception_3b_3x3_conv1\')(X)\n    X_3x3 = BatchNormalization(axis=1, epsilon=0.00001, name=\'inception_3b_3x3_bn1\')(X_3x3)\n    X_3x3 = Activation(\'relu\')(X_3x3)\n    X_3x3 = ZeroPadding2D(padding=(1, 1), data_format=\'channels_first\')(X_3x3)\n    X_3x3 = Conv2D(128, (3, 3), data_format=\'channels_first\', name=\'inception_3b_3x3_conv2\')(X_3x3)\n    X_3x3 = BatchNormalization(axis=1, epsilon=0.00001, name=\'inception_3b_3x3_bn2\')(X_3x3)\n    X_3x3 = Activation(\'relu\')(X_3x3)\n\n    X_5x5 = Conv2D(32, (1, 1), data_format=\'channels_first\', name=\'inception_3b_5x5_conv1\')(X)\n    X_5x5 = BatchNormalization(axis=1, epsilon=0.00001, name=\'inception_3b_5x5_bn1\')(X_5x5)\n    X_5x5 = Activation(\'relu\')(X_5x5)\n    X_5x5 = ZeroPadding2D(padding=(2, 2), data_format=\'channels_first\')(X_5x5)\n    X_5x5 = Conv2D(64, (5, 5), data_format=\'channels_first\', name=\'inception_3b_5x5_conv2\')(X_5x5)\n    X_5x5 = BatchNormalization(axis=1, epsilon=0.00001, name=\'inception_3b_5x5_bn2\')(X_5x5)\n    X_5x5 = Activation(\'relu\')(X_5x5)\n\n    X_pool = AveragePooling2D(pool_size=(3, 3), strides=(3, 3), data_format=\'channels_first\')(X)\n    X_pool = Conv2D(64, (1, 1), data_format=\'channels_first\', name=\'inception_3b_pool_conv\')(X_pool)\n    X_pool = BatchNormalization(axis=1, epsilon=0.00001, name=\'inception_3b_pool_bn\')(X_pool)\n    X_pool = Activation(\'relu\')(X_pool)\n    X_pool = ZeroPadding2D(padding=(4, 4), data_format=\'channels_first\')(X_pool)\n\n    X_1x1 = Conv2D(64, (1, 1), data_format=\'channels_first\', name=\'inception_3b_1x1_conv\')(X)\n    X_1x1 = BatchNormalization(axis=1, epsilon=0.00001, name=\'inception_3b_1x1_bn\')(X_1x1)\n    X_1x1 = Activation(\'relu\')(X_1x1)\n\n    inception = concatenate([X_3x3, X_5x5, X_pool, X_1x1], axis=1)\n\n    return inception\n\ndef inception_block_1c(X):\n    X_3x3 = fr_utils.conv2d_bn(X,\n                           layer=\'inception_3c_3x3\',\n                           cv1_out=128,\n                           cv1_filter=(1, 1),\n                           cv2_out=256,\n                           cv2_filter=(3, 3),\n                           cv2_strides=(2, 2),\n                           padding=(1, 1))\n\n    X_5x5 = fr_utils.conv2d_bn(X,\n                           layer=\'inception_3c_5x5\',\n                           cv1_out=32,\n                           cv1_filter=(1, 1),\n                           cv2_out=64,\n                           cv2_filter=(5, 5),\n                           cv2_strides=(2, 2),\n                           padding=(2, 2))\n\n    X_pool = MaxPooling2D(pool_size=3, strides=2, data_format=\'channels_first\')(X)\n    X_pool = ZeroPadding2D(padding=((0, 1), (0, 1)), data_format=\'channels_first\')(X_pool)\n\n    inception = concatenate([X_3x3, X_5x5, X_pool], axis=1)\n\n    return inception\n\ndef inception_block_2a(X):\n    X_3x3 = fr_utils.conv2d_bn(X,\n                           layer=\'inception_4a_3x3\',\n                           cv1_out=96,\n                           cv1_filter=(1, 1),\n                           cv2_out=192,\n                           cv2_filter=(3, 3),\n                           cv2_strides=(1, 1),\n                           padding=(1, 1))\n    X_5x5 = fr_utils.conv2d_bn(X,\n                           layer=\'inception_4a_5x5\',\n                           cv1_out=32,\n                           cv1_filter=(1, 1),\n                           cv2_out=64,\n                           cv2_filter=(5, 5),\n                           cv2_strides=(1, 1),\n                           padding=(2, 2))\n\n    X_pool = AveragePooling2D(pool_size=(3, 3), strides=(3, 3), data_format=\'channels_first\')(X)\n    X_pool = fr_utils.conv2d_bn(X_pool,\n                           layer=\'inception_4a_pool\',\n                           cv1_out=128,\n                           cv1_filter=(1, 1),\n                           padding=(2, 2))\n    X_1x1 = fr_utils.conv2d_bn(X,\n                           layer=\'inception_4a_1x1\',\n                           cv1_out=256,\n                           cv1_filter=(1, 1))\n    inception = concatenate([X_3x3, X_5x5, X_pool, X_1x1], axis=1)\n\n    return inception\n\ndef inception_block_2b(X):\n    #inception4e\n    X_3x3 = fr_utils.conv2d_bn(X,\n                           layer=\'inception_4e_3x3\',\n                           cv1_out=160,\n                           cv1_filter=(1, 1),\n                           cv2_out=256,\n                           cv2_filter=(3, 3),\n                           cv2_strides=(2, 2),\n                           padding=(1, 1))\n    X_5x5 = fr_utils.conv2d_bn(X,\n                           layer=\'inception_4e_5x5\',\n                           cv1_out=64,\n                           cv1_filter=(1, 1),\n                           cv2_out=128,\n                           cv2_filter=(5, 5),\n                           cv2_strides=(2, 2),\n                           padding=(2, 2))\n    \n    X_pool = MaxPooling2D(pool_size=3, strides=2, data_format=\'channels_first\')(X)\n    X_pool = ZeroPadding2D(padding=((0, 1), (0, 1)), data_format=\'channels_first\')(X_pool)\n\n    inception = concatenate([X_3x3, X_5x5, X_pool], axis=1)\n\n    return inception\n\ndef inception_block_3a(X):\n    X_3x3 = fr_utils.conv2d_bn(X,\n                           layer=\'inception_5a_3x3\',\n                           cv1_out=96,\n                           cv1_filter=(1, 1),\n                           cv2_out=384,\n                           cv2_filter=(3, 3),\n                           cv2_strides=(1, 1),\n                           padding=(1, 1))\n    X_pool = AveragePooling2D(pool_size=(3, 3), strides=(3, 3), data_format=\'channels_first\')(X)\n    X_pool = fr_utils.conv2d_bn(X_pool,\n                           layer=\'inception_5a_pool\',\n                           cv1_out=96,\n                           cv1_filter=(1, 1),\n                           padding=(1, 1))\n    X_1x1 = fr_utils.conv2d_bn(X,\n                           layer=\'inception_5a_1x1\',\n                           cv1_out=256,\n                           cv1_filter=(1, 1))\n\n    inception = concatenate([X_3x3, X_pool, X_1x1], axis=1)\n\n    return inception\n\ndef inception_block_3b(X):\n    X_3x3 = fr_utils.conv2d_bn(X,\n                           layer=\'inception_5b_3x3\',\n                           cv1_out=96,\n                           cv1_filter=(1, 1),\n                           cv2_out=384,\n                           cv2_filter=(3, 3),\n                           cv2_strides=(1, 1),\n                           padding=(1, 1))\n    X_pool = MaxPooling2D(pool_size=3, strides=2, data_format=\'channels_first\')(X)\n    X_pool = fr_utils.conv2d_bn(X_pool,\n                           layer=\'inception_5b_pool\',\n                           cv1_out=96,\n                           cv1_filter=(1, 1))\n    X_pool = ZeroPadding2D(padding=(1, 1), data_format=\'channels_first\')(X_pool)\n\n    X_1x1 = fr_utils.conv2d_bn(X,\n                           layer=\'inception_5b_1x1\',\n                           cv1_out=256,\n                           cv1_filter=(1, 1))\n    inception = concatenate([X_3x3, X_pool, X_1x1], axis=1)\n\n    return inception\n\ndef faceRecoModel(input_shape):\n    """"""\n    Implementation of the Inception model used for FaceNet\n    \n    Arguments:\n    input_shape -- shape of the images of the dataset\n\n    Returns:\n    model -- a Model() instance in Keras\n    """"""\n        \n    # Define the input as a tensor with shape input_shape\n    X_input = Input(input_shape)\n\n    # Zero-Padding\n    X = ZeroPadding2D((3, 3))(X_input)\n    \n    # First Block\n    X = Conv2D(64, (7, 7), strides = (2, 2), name = \'conv1\')(X)\n    X = BatchNormalization(axis = 1, name = \'bn1\')(X)\n    X = Activation(\'relu\')(X)\n    \n    # Zero-Padding + MAXPOOL\n    X = ZeroPadding2D((1, 1))(X)\n    X = MaxPooling2D((3, 3), strides = 2)(X)\n    \n    # Second Block\n    X = Conv2D(64, (1, 1), strides = (1, 1), name = \'conv2\')(X)\n    X = BatchNormalization(axis = 1, epsilon=0.00001, name = \'bn2\')(X)\n    X = Activation(\'relu\')(X)\n    \n    # Zero-Padding + MAXPOOL\n    X = ZeroPadding2D((1, 1))(X)\n\n    # Second Block\n    X = Conv2D(192, (3, 3), strides = (1, 1), name = \'conv3\')(X)\n    X = BatchNormalization(axis = 1, epsilon=0.00001, name = \'bn3\')(X)\n    X = Activation(\'relu\')(X)\n    \n    # Zero-Padding + MAXPOOL\n    X = ZeroPadding2D((1, 1))(X)\n    X = MaxPooling2D(pool_size = 3, strides = 2)(X)\n    \n    # Inception 1: a/b/c\n    X = inception_block_1a(X)\n    X = inception_block_1b(X)\n    X = inception_block_1c(X)\n    \n    # Inception 2: a/b\n    X = inception_block_2a(X)\n    X = inception_block_2b(X)\n    \n    # Inception 3: a/b\n    X = inception_block_3a(X)\n    X = inception_block_3b(X)\n    \n    # Top layer\n    X = AveragePooling2D(pool_size=(3, 3), strides=(1, 1), data_format=\'channels_first\')(X)\n    X = Flatten()(X)\n    X = Dense(128, name=\'dense_layer\')(X)\n    \n    # L2 normalization\n    X = Lambda(lambda  x: K.l2_normalize(x,axis=1))(X)\n\n    # Create model instance\n    model = Model(inputs = X_input, outputs = X, name=\'FaceRecoModel\')\n        \n    return model'"
