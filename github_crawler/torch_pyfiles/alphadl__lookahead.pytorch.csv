file_path,api_count,code
lookahead.py,3,"b'from collections import defaultdict\nfrom itertools import chain\nfrom torch.optim import Optimizer\nimport torch\nimport warnings\n\nclass Lookahead(Optimizer):\n    def __init__(self, optimizer, k=5, alpha=0.5):\n        self.optimizer = optimizer\n        self.k = k\n        self.alpha = alpha\n        self.param_groups = self.optimizer.param_groups\n        self.state = defaultdict(dict)\n        self.fast_state = self.optimizer.state\n        for group in self.param_groups:\n            group[""counter""] = 0\n    \n    def update(self, group):\n        for fast in group[""params""]:\n            param_state = self.state[fast]\n            if ""slow_param"" not in param_state:\n                param_state[""slow_param""] = torch.zeros_like(fast.data)\n                param_state[""slow_param""].copy_(fast.data)\n            slow = param_state[""slow_param""]\n            slow += (fast.data - slow) * self.alpha\n            fast.data.copy_(slow)\n    \n    def update_lookahead(self):\n        for group in self.param_groups:\n            self.update(group)\n\n    def step(self, closure=None):\n        loss = self.optimizer.step(closure)\n        for group in self.param_groups:\n            if group[""counter""] == 0:\n                self.update(group)\n            group[""counter""] += 1\n            if group[""counter""] >= self.k:\n                group[""counter""] = 0\n        return loss\n\n    def state_dict(self):\n        fast_state_dict = self.optimizer.state_dict()\n        slow_state = {\n            (id(k) if isinstance(k, torch.Tensor) else k): v\n            for k, v in self.state.items()\n        }\n        fast_state = fast_state_dict[""state""]\n        param_groups = fast_state_dict[""param_groups""]\n        return {\n            ""fast_state"": fast_state,\n            ""slow_state"": slow_state,\n            ""param_groups"": param_groups,\n        }\n\n    def load_state_dict(self, state_dict):\n        slow_state_dict = {\n            ""state"": state_dict[""slow_state""],\n            ""param_groups"": state_dict[""param_groups""],\n        }\n        fast_state_dict = {\n            ""state"": state_dict[""fast_state""],\n            ""param_groups"": state_dict[""param_groups""],\n        }\n        super(Lookahead, self).load_state_dict(slow_state_dict)\n        self.optimizer.load_state_dict(fast_state_dict)\n        self.fast_state = self.optimizer.state\n\n    def add_param_group(self, param_group):\n        param_group[""counter""] = 0\n        self.optimizer.add_param_group(param_group)\n'"
